# Refatoração Backend Rust + Migração OpenCode Híbrido

## Why This PRD Exists

**Context:** ralph/loop.sh runs prd.json tasks via opencode CLI. Each task = new session = zero context.
**Problem:** bash loop = manual work, bad UX, no visibility, cant skip/pause subtasks.
**Solution:** Make Tasks plugin work with OpenCode SDK. Then: UI shows progress, can pause mid-task, see which subtask running, navigate away and back.

**This file:** Preserves learnings between sessions. Next session reads this to not repeat mistakes.

---

## Current Status
Task 0 of 26 - Starting

## Rollback Plan
Branch dedicada. Se falhar, git checkout main.

---

## Key Files (read first)

### Backend Rust (refactor targets)
- `src-tauri/src/plugins/tasks/commands.rs` - 986 lines, repetitive, needs helpers
- `src-tauri/src/plugins/tasks/opencode.rs` - 1092 lines, will be split/simplified
- `src-tauri/src/plugins/tasks/types.rs` - Task, Subtask, Folder types
- `src-tauri/src/traces/` - Tracing system already exists, use Trace::new().with()

### Frontend (already working, will add SDK)
- `src/plugins/tasks/TasksPlugin.tsx` - Main component, has views: folders/list/task
- `src/plugins/tasks/useTasksStorage.ts` - Hooks, already has useOpenCodeServer
- `src/plugins/tasks/components/SubtaskItem.tsx` - Shows subtask, has Run/Stop buttons

### Config
- `src-tauri/src/lib.rs` - invoke_handler registers all commands
- `CLAUDE.md` - Project conventions, must follow

## Gotchas

- `cargo check` must run from `src-tauri/` directory
- Trace system exists: `use crate::traces::Trace` then `Trace::new().with("key", "val")`
- UI already works! Don't rebuild it. Focus on backend refactor + SDK migration.
- OpenCode server runs on port 4096, started as child process by Rust
- SDK docs: https://opencode.ai/docs/sdk/

---

## Tasks

### Fase 1: Helpers para commands.rs (4 tarefas)
- [ ] 1. Criar tasks/helpers.rs com funções find_*
- [ ] 2. Criar helpers with_*_mut para mutações com save automático
- [ ] 3. Refatorar comandos de folder usando helpers
- [ ] 4. Refatorar comandos de task/subtask/step/tag usando helpers

### Fase 2: Traces em todos os comandos (5 tarefas)
- [ ] 5. Adicionar traces aos comandos de folder
- [ ] 6. Adicionar traces aos comandos de tasks
- [ ] 7. Adicionar traces aos comandos de subtasks e steps
- [ ] 8. Adicionar traces aos comandos de tags e execution_logs
- [ ] 9. Adicionar traces aos comandos de opencode

### Fase 3: Migração OpenCode Híbrido (18 tarefas)

#### 3.1 Spike e Setup (6 tarefas)
- [ ] 10. [SPIKE] Validar SDK OpenCode - instalar e testar básico
- [ ] 11. Criar estrutura base do módulo opencode no frontend
- [ ] 12. Criar client wrapper singleton
- [ ] 13. Criar estado global para sessões (Zustand)
- [ ] 14. Implementar listener de eventos SSE
- [ ] 15. Criar hooks React para OpenCode

#### 3.2 Backend Rust (2 tarefas)
- [ ] 16. Simplificar opencode.rs - extrair server lifecycle
- [ ] 17. Criar comandos Rust para persistência de sessões

#### 3.3 Migração Frontend (4 tarefas)
- [ ] 18. Migrar frontend - criar sessão via SDK
- [ ] 19. Migrar frontend - send prompt via SDK
- [ ] 20. Migrar frontend - abort e status via SDK
- [ ] 21. Remover código Rust obsoleto

### Fase 4: Limpeza e Documentação (3 tarefas)
- [ ] 22. Remover shared/errors.rs
- [ ] 23. Atualizar CLAUDE.md com nova arquitetura

### Fase 5: Testes e Validação (3 tarefas)
- [ ] 24. Testes de integração - Fase 1 e 2 (helpers + traces)
- [ ] 25. Testes de integração - Fase 3 (OpenCode híbrido)
- [ ] 26. Verificação final e merge

---

## Architecture Summary

### Arquitetura Híbrida Final

```
┌─────────────────────────────────────────────────────────────┐
│                   Frontend (React + SDK)                    │
│                                                             │
│  src/lib/opencode/                                          │
│  ├── index.ts        # Re-exports                          │
│  ├── client.ts       # Singleton SDK client                │
│  ├── state.ts        # Zustand store para sessões          │
│  ├── events.ts       # SSE listener + handlers             │
│  ├── hooks.ts        # useOpenCodeSession, useSendPrompt   │
│  ├── actions.ts      # createSession, sendPrompt, abort    │
│  └── types.ts        # Tipos locais                        │
│                                                             │
│  Responsabilidades:                                         │
│  - Todas as operações de sessão via SDK                    │
│  - SSE events para updates real-time                       │
│  - Estado global persiste entre navegações                 │
└─────────────────────────────────────────────────────────────┘
                              ↕ IPC (Tauri invoke)
┌─────────────────────────────────────────────────────────────┐
│                     Backend (Rust)                          │
│                                                             │
│  src-tauri/src/plugins/tasks/opencode/                     │
│  ├── mod.rs          # Re-exports                          │
│  ├── state.rs        # OpenCodeServerState                 │
│  ├── server.rs       # ensure_server, stop_server, health  │
│  └── persistence.rs  # persist_session, get_sessions       │
│                                                             │
│  Responsabilidades:                                         │
│  - Start/stop servidor OpenCode (processo filho)           │
│  - Health check                                            │
│  - Persistir session_id para recuperar ao navegar          │
│  - ~200 linhas (vs 1092 original)                          │
└─────────────────────────────────────────────────────────────┘
```

### Comandos Tauri

#### Mantidos (lifecycle + persistence)
- `opencode_ensure_server` - inicia servidor
- `opencode_stop_server` - para servidor  
- `opencode_health_check` - verifica saúde
- `opencode_persist_session` - salva session para recuperar
- `opencode_get_persisted_sessions` - lista sessões ativas
- `opencode_clear_session` - remove sessão persistida

#### Removidos (SDK faz no frontend)
- `opencode_create_session` → `client.session.create()`
- `opencode_send_prompt` → `client.session.prompt()`
- `opencode_poll_status` → SSE events
- `opencode_abort_session` → `client.session.abort()`

### Benefícios
- SDK TypeScript dá acesso a TODAS as funcionalidades do OpenCode
- SSE events substituem polling (real-time, menor latência)
- Estado persiste entre navegações de plugins
- Backend Rust 5x menor e mais focado
- Tipos gerados do OpenAPI spec (type-safe)

---

## Progress Log

(Entries will be added as tasks are completed)

## 2026-01-22 16:28 - Task 1
- What was implemented
- Added tasks/helpers.rs with pub find_* helpers for folders, tasks, subtasks, steps, and tags
- Files changed
- `src-tauri/src/plugins/tasks/helpers.rs`
- `src-tauri/src/plugins/tasks/mod.rs`
- **Learnings for future iterations:**
- Patterns discovered (e.g., "this codebase uses X for Y")
- Small helper modules live alongside commands in `src-tauri/src/plugins/tasks/`
- Gotchas encountered (e.g., "don't forget to update Z when changing W")
- Rust helper functions returning references need explicit lifetimes
- Useful context (e.g., "the evaluation panel is in component X")
- Helpers are intended for later refactors of `src-tauri/src/plugins/tasks/commands.rs`

## 2026-01-22 16:30 - Task 2
- What was implemented
- Added with_*_mut helpers to centralize lock/find/mutate/save flow for folders, tasks, subtasks, steps, and tags
- Files changed
- `src-tauri/src/plugins/tasks/helpers.rs`
- **Learnings for future iterations:**
- Patterns discovered (e.g., "this codebase uses X for Y")
- Helper functions can take &TasksStore and return Result<R, String> to standardize errors
- Gotchas encountered (e.g., "don't forget to update Z when changing W")
- save_to_json should be called after successful mutation to keep persistence consistent
- Useful context (e.g., "the evaluation panel is in component X")
- with_*_mut helpers follow the same not-found error strings used in commands.rs

## 2026-01-22 16:32 - Task 3
- What was implemented
- Refactored folder rename/delete/reorder commands to use shared helper functions for lookup and mutation
- Files changed
- `src-tauri/src/plugins/tasks/commands.rs`
- **Learnings for future iterations:**
- Patterns discovered (e.g., "this codebase uses X for Y")
- Helper functions can be mixed with direct store writes when cascade deletes are needed
- Gotchas encountered (e.g., "don't forget to update Z when changing W")
- Use `store.inner()` to pass `State<TasksStore>` into helpers expecting `&TasksStore`
- Useful context (e.g., "the evaluation panel is in component X")
- Folder reorder can rely on helpers without changing persistence behavior

## 2026-01-22 16:35 - Task 4
- What was implemented
- Refactored task, subtask, step, and tag update commands to use with_*_mut helpers for shared lock/mutate/save flow
- Files changed
- `src-tauri/src/plugins/tasks/commands.rs`
- **Learnings for future iterations:**
- Patterns discovered (e.g., "this codebase uses X for Y")
- Use read locks for validation (like tag duplication checks) before entering helper write locks
- Gotchas encountered (e.g., "don't forget to update Z when changing W")
- Drop read guards before calling helpers to avoid lock contention
- Useful context (e.g., "the evaluation panel is in component X")
- with_*_mut helpers can return values for toggles without extra save logic

## 2026-01-22 17:05 - Task 5
- What was implemented
- Added tracing to folder_create, folder_rename, folder_delete, and folder_reorder with plugin/action context and start/finish info logs
- Files changed
- `src-tauri/src/plugins/tasks/commands.rs`
- **Learnings for future iterations:**
- Patterns discovered (e.g., "this codebase uses X for Y")
- Folder commands now follow the trace pattern from folder_get_all with explicit drop(trace)
- Gotchas encountered (e.g., "don't forget to update Z when changing W")
- Early returns should log and drop the trace to ensure traceend entries are emitted
- Useful context (e.g., "the evaluation panel is in component X")
- Use Trace::with("folder_id", id.clone()) for per-folder context

## 2026-01-22 17:22 - Task 6
- What was implemented
- Added trace instrumentation to tasks_get_by_folder, tasks_create, tasks_update_status, tasks_update_text, tasks_delete, tasks_set_tags, and tasks_update_description with task/folder context and start/finish info logs
- Files changed
- `src-tauri/src/plugins/tasks/commands.rs`
- **Learnings for future iterations:**
- Patterns discovered (e.g., "this codebase uses X for Y")
- Task commands follow the same trace pattern with explicit drop(trace) before returning
- Gotchas encountered (e.g., "don't forget to update Z when changing W")
- Validate input before mutating and log early returns to keep traceend entries consistent
- Useful context (e.g., "the evaluation panel is in component X")
- Include tag counts in trace info when updating task tags for extra context

## 2026-01-22 16:41 - Task 7
- What was implemented
- Added trace instrumentation across subtask and step commands, including updates, toggles, deletes, and reorder flows with task/subtask/step context
- Files changed
- `src-tauri/src/plugins/tasks/commands.rs`
- **Learnings for future iterations:**
- Patterns discovered (e.g., "this codebase uses X for Y")
- Subtask/step commands can follow the same trace start/finish pattern as folder/task commands
- Gotchas encountered (e.g., "don't forget to update Z when changing W")
- Log and drop traces on validation errors (empty text/invalid status) to keep traceend entries consistent
- Useful context (e.g., "the evaluation panel is in component X")
- Include task_id/subtask_id/step_id in trace context for debugging nested operations

## 2026-01-22 17:40 - Task 8
- What was implemented
- Added trace instrumentation to tag_create, tag_update, tag_delete, and execution_logs_create with task/folder/tag context and start/finish info logs
- Files changed
- `src-tauri/src/plugins/tasks/commands.rs`
- **Learnings for future iterations:**
- Patterns discovered (e.g., "this codebase uses X for Y")
- Tag and execution log commands follow the same trace start/finish pattern with explicit drop(trace)
- Gotchas encountered (e.g., "don't forget to update Z when changing W")
- Wrap save_to_json errors to log and drop traces before returning
- Useful context (e.g., "the evaluation panel is in component X")
- Include tag_id/task_id/subtask_id in trace context for debugging lookups
