# Todo Folders System - Progress Log

## Feature Overview
Implement a folder system for the Todo plugin. The main screen shows a list of folders with previews of the last 2 todos. Clicking a folder navigates to the existing todo/tags view, now scoped to that folder.

## Design Decisions
- Navigation: Back button in header (uses existing plugin header customization)
- Tags: Isolated per folder (not global)
- Folder creation: "+" button reveals inline input
- Folder display: Vertical list with preview of 2 most recent todos
- Folder management: Rename, delete, reorder (drag & drop)
- Deletion: Confirmation modal with 5-second countdown on delete button

---

## 2026-01-16 - Task 1: Backend - Create folders table and migrate existing data
- What was implemented:
  - Created `folders` table with columns: id, name, position, created_at
  - Added `folder_id` column to `todos` table with foreign key (ON DELETE CASCADE)
  - Added `folder_id` column to `tags` table with foreign key (ON DELETE CASCADE)
  - Changed tags uniqueness constraint from global to per-folder (UNIQUE(name, folder_id))
  - Created `migrate_to_folders_schema()` function that:
    - Creates a "Default" folder
    - Migrates existing todos and tags to the default folder
    - Uses table recreation pattern (SQLite doesn't support ADD COLUMN with FK easily)
  - Updated `migrate_legacy_json()` to include folder_id when importing from JSON
- Files changed:
  - `src-tauri/src/storage/migrations.rs`
- **Learnings for future iterations:**
  - SQLite doesn't support ALTER TABLE ADD COLUMN with foreign key constraints well - use table recreation pattern
  - Check column existence with `conn.prepare("SELECT col FROM table LIMIT 1").is_ok()`
  - Cargo workspace is in `src-tauri/`, not project root
  - Migration runs on every startup - use `CREATE TABLE IF NOT EXISTS` for idempotency
  - The `execute_batch` function doesn't support parameterized queries - use format! for dynamic values

---

## 2026-01-16 - Task 2: Backend - Implement folder CRUD commands
- What was implemented:
  - Created `folder.rs` module with 5 Tauri commands:
    - `folder_get_all`: Returns all folders with `todoCount` and `recentTodos` (last 2 todos preview)
    - `folder_create`: Creates new folder with auto-incremented position, validates non-empty name
    - `folder_rename`: Renames folder by ID, validates non-empty name
    - `folder_delete`: Deletes folder (CASCADE handles todos/tags cleanup)
    - `folder_reorder`: Accepts ordered list of folder IDs and updates positions
  - Response types use `#[serde(rename_all = "camelCase")]` for frontend compatibility
  - Registered module in `storage/mod.rs`
  - Registered all 5 commands in `lib.rs` invoke_handler
- Files changed:
  - `src-tauri/src/storage/folder.rs` (new file)
  - `src-tauri/src/storage/mod.rs`
  - `src-tauri/src/lib.rs`
- **Learnings for future iterations:**
  - Follow same patterns as `todo.rs`: State<Database>, map_err for errors, filter_map for queries
  - Position field uses `COALESCE(MAX(position), -1) + 1` for next position calculation
  - For N+1 queries (getting count/recent for each folder), consider JOIN optimization if performance becomes an issue
  - Folder deletion relies on CASCADE - no need to manually delete todos/tags

---

## 2026-01-16 - Task 3: Backend - Update existing todo/tag commands to use folder_id
- What was implemented:
  - Replaced `todo_get_all` with `todo_get_by_folder(folder_id)`:
    - Now filters todos and tags by the specified folder_id
    - Queries use `WHERE folder_id = ?1` for both todos and tags
  - Updated `todo_create` to receive `folder_id` parameter:
    - Added `folder_id` as the first parameter (before text and tag_ids)
    - INSERT now includes folder_id column
  - Updated `tag_create` to receive `folder_id` parameter:
    - Added `folder_id` as the first parameter (before name and color)
    - INSERT now includes folder_id column
  - Updated error messages to clarify per-folder scope:
    - Both `tag_create` and `tag_update` now show "Tag name already exists in this folder"
  - Updated command registration in `lib.rs` to use `todo_get_by_folder` instead of `todo_get_all`
- Files changed:
  - `src-tauri/src/storage/todo.rs`
  - `src-tauri/src/lib.rs`
- **Learnings for future iterations:**
  - Tag uniqueness is enforced by DB constraint `UNIQUE(name, folder_id)` - no additional code needed
  - When renaming commands, update both the function and the invoke_handler registration
  - The `tag_update` function doesn't need folder_id since it updates by tag ID (folder_id is immutable after creation)

---

## 2026-01-16 - Task 4: Frontend - Add Folder type and update useTodoStorage hook
- What was implemented:
  - Added `Folder` and `RecentTodo` interfaces to `types.ts`:
    - `RecentTodo`: id, text, status (matches backend `RecentTodo` struct)
    - `Folder`: id, name, position, createdAt, todoCount, recentTodos
  - Updated `useTodoStorage` hook to require `folderId` parameter:
    - Changed `todo_get_all` call to `todo_get_by_folder(folderId)`
    - Updated `createTodo` to pass `folderId` to backend
    - Updated `createTag` to pass `folderId` to backend
    - Added `folderId` to the dependencies array for relevant callbacks
  - Created new `useFolderStorage` hook with folder operations:
    - `loadFolders`: Fetches all folders from backend
    - `createFolder`: Creates folder with optimistic update (temp ID pattern)
    - `renameFolder`: Renames folder with rollback on error
    - `deleteFolder`: Deletes folder with rollback on error
    - `reorderFolders`: Reorders folders based on ID array with rollback
  - Updated `TodoPlugin` to use the folder system:
    - Uses `useFolderStorage` to get folders
    - Uses first folder's ID as `currentFolderId` for `useTodoStorage`
    - Combines loading states from both hooks
- Files changed:
  - `src/plugins/todo/types.ts`
  - `src/plugins/todo/useTodoStorage.ts`
  - `src/plugins/todo/TodoPlugin.tsx`
- **Learnings for future iterations:**
  - Follow the existing optimistic update patterns: temp ID for creates, previous state capture for updates/deletes
  - When a hook requires a parameter, dependent components need to provide it - may require temporary scaffolding
  - The `folders[0]?.id ?? ''` pattern is a temporary solution until proper folder navigation is implemented in Task 5/6
  - Backend response types with `#[serde(rename_all = "camelCase")]` map directly to frontend interfaces

---

## 2026-01-16 - Task 5: Frontend - Implement folder list view (main screen)
- What was implemented:
  - Refactored `TodoPlugin` to have three views: `folders`, `list`, `tags`
  - Added `currentFolderId` state (null when on folder list, folder ID when inside a folder)
  - Folder list view is now the main entry point (instead of going directly to todos)
  - Created `TodoPluginFolderList` component showing all folders sorted by position
  - Created `TodoPluginFolderCard` component displaying:
    - Folder name with 14px font weight medium
    - Todo count badge (rounded pill on the right)
    - Preview of last 2 todos with status indicators (colored dots)
  - Created `TodoPluginFolderPreview` component:
    - Shows "(empty)" in italic when no todos
    - Shows truncated todo text with status-appropriate styling
    - Pending/in-progress todos show as white/50, completed as white/30 with line-through
  - Created `TodoPluginFolderInput` component for inline folder creation:
    - Auto-focuses on mount
    - Enter to submit, Escape to cancel
    - Blur closes if empty
  - Created `TodoPluginFoldersEmptyState` for when no folders exist
  - Added '+' button in header (right side) that reveals inline input
  - Navigation: Clicking folder sets `currentFolderId` and switches to `list` view
  - Back navigation from folder view refreshes folder list data
  - Imported `FolderOpen` icon from lucide-react for the folders view header
- Files changed:
  - `src/plugins/todo/TodoPlugin.tsx`
- **Learnings for future iterations:**
  - The `PluginHeader` component accepts a `right` prop for custom content in the header
  - Follow the existing pattern of mini-components defined after the main component
  - Use `useRef` + `useEffect` to auto-focus inputs on mount
  - The `cn()` utility handles conditional class composition well
  - Empty state components with action buttons provide better UX than just text

---

## 2026-01-16 - Task 6: Frontend - Implement folder content view with navigation
- What was implemented:
  - Added settings icon (gear) in header when inside a folder:
    - Uses `Settings` icon from lucide-react
    - Clicking opens a dropdown menu with Rename/Delete options
    - Shows folder stats (task count, tag count) at the bottom
  - Created `TodoPluginFolderSettingsMenu` component:
    - Dropdown menu positioned below the settings button
    - Rename option with pencil icon
    - Delete option in red with X icon
    - Info footer showing "X tasks, Y tags"
    - Closes when clicking outside (useEffect with mousedown listener)
  - Created `TodoPluginRenameFolderModal` component:
    - Modal overlay with backdrop blur
    - Pre-filled input with current folder name
    - Auto-focuses and selects text on open
    - Enter to save, Escape to cancel
    - Cancel and Save buttons
  - Added "Tasks" section title above the todo list:
    - Styled as uppercase 12px text with reduced opacity
    - Provides visual separation between tag filter and todo list
  - Added state management for folder operations:
    - `isSettingsMenuOpen`: Controls visibility of settings dropdown
    - `isRenamingFolder`: Controls visibility of rename modal
    - `renameFolderValue`: Stores the new folder name during editing
  - Header props now conditionally include the settings button for list view
- Files changed:
  - `src/plugins/todo/TodoPlugin.tsx`
- **Learnings for future iterations:**
  - The `PluginHeader` component's `right` prop accepts any ReactNode, allowing complex UI elements
  - Dropdown menus need `onClick={(e) => e.stopPropagation()}` to prevent closing when clicking inside
  - Use `useRef` with mousedown event listener for click-outside detection
  - When implementing modals, remember to auto-focus and select input content with `inputRef.current?.select()`
  - Section titles (like "Tasks") help organize content without needing visual borders

---

## 2026-01-16 - Task 7: Frontend - Implement folder rename functionality
- What was implemented:
  - Verified that all rename functionality was already implemented in Task 6:
    - `TodoPluginRenameFolderModal` component with modal overlay and backdrop blur
    - Pre-filled input with current folder name that auto-focuses and selects text
    - Enter to save, Escape to cancel keyboard shortcuts
    - Cancel and Save buttons with Save disabled when input is empty
  - Verified `renameFolder` in `useFolderStorage` hook:
    - Optimistic update: folder name updates immediately in UI
    - Rollback on error: reverts to previous state if backend fails
    - Toast notification: `toast.error('Failed to rename folder')` on failure
  - Validation: Non-empty name check in `handleRenameFolder` with `renameFolderValue.trim()`
  - All requirements from PRD were already satisfied by Task 6 implementation
- Files changed:
  - `ralph/prd.json` (marked task as passes: true)
  - No code changes required - implementation was already complete
- **Learnings for future iterations:**
  - When implementing a feature with settings menu + rename/delete options, the rename modal often gets implemented together with the settings menu
  - Always verify existing implementation before adding new code - duplicate functionality may already exist
  - The separation of concerns in PRD tasks doesn't always match implementation order; complex features often get partially implemented across multiple tasks
  - Toast notifications via `sonner` are already integrated in `useTodoStorage.ts` - reuse existing patterns

---

## 2026-01-16 - Task 8: Frontend - Implement folder delete with countdown confirmation
- What was implemented:
  - Created `TodoPluginDeleteFolderModal` component with:
    - Modal overlay with backdrop blur (consistent with rename modal)
    - Message showing "Delete [folderName]? This will remove X tasks and Y tags."
    - 5-second countdown timer using `setInterval`
    - Delete button disabled during countdown, showing "Delete (5s)" → "Delete (4s)" → ... → "Delete"
    - Button styling: red-500/40 when disabled, red-500 when enabled
    - Cancel button to dismiss modal
  - Added `isDeletingFolder` state to track modal visibility
  - Renamed `handleDeleteFolder` to `handleStartDeleteFolder` (opens modal)
  - Added `handleConfirmDeleteFolder` (executes actual deletion)
  - Modal displays current folder's todoCount and tags.length for accurate counts
  - On successful deletion, modal closes and navigates back to folder list
- Files changed:
  - `src/plugins/todo/TodoPlugin.tsx`
- **Learnings for future iterations:**
  - The countdown pattern using `setInterval` with cleanup in `useEffect` is straightforward: decrement until 0, then stop
  - For countdown-style buttons, track `countdown <= 0` as `isDeleteEnabled` for clean conditional rendering
  - Destructive action modals should prevent accidental clicks - the 5s countdown gives users time to cancel
  - Consistent modal styling (width, border-radius, padding, backdrop) across the app makes implementation faster

---

## 2026-01-16 - Task 9: Frontend - Implement drag and drop folder reordering
- What was implemented:
  - Added `GripVertical` drag handle icon from lucide-react to each folder card
  - Added drag state management to `TodoPluginFolderList` component:
    - `draggedId`: tracks which folder is being dragged
    - `dragOverId`: tracks which folder is being hovered over
    - `dropPosition`: tracks whether to drop 'above' or 'below' the target
  - Implemented native HTML5 Drag and Drop API with event handlers:
    - `handleDragStart`: sets dragged folder ID and dataTransfer
    - `handleDragEnd`: clears all drag state
    - `handleDragOver`: calculates drop position based on mouse Y relative to element midpoint
    - `handleDragLeave`: clears drag over state
    - `handleDrop`: reorders the folder array and calls `reorderFolders`
  - Visual indicators for drop position:
    - White horizontal line (h-0.5) appears above or below the target card
    - Dragged card becomes semi-transparent (opacity-50) with slight scale reduction
    - Drag handle shows cursor-grab/cursor-grabbing states
  - Updated `TodoPluginFolderCard` to accept drag-related props and show visual feedback
  - Passed `reorderFolders` from `useFolderStorage` hook to the folder list component
  - Folder preview content now indented (pl-5) to align with drag handle
- Files changed:
  - `src/plugins/todo/TodoPlugin.tsx`
- **Learnings for future iterations:**
  - Native HTML5 Drag and Drop API is sufficient for simple list reordering without external dependencies
  - Use `e.currentTarget.getBoundingClientRect()` and compare `e.clientY` to midpoint for above/below positioning
  - Tailwind's `before:` and `after:` pseudo-element utilities work well for drop position indicators
  - The reorder logic needs to account for whether the dragged item was above or below the target when calculating the insert index
  - `draggable` attribute goes on the outer container, click handler goes on the inner button to keep them separate

