# Tasks Plugin - PRD Automation Feature

## Current Status
Task 2 of 19 completed

## Tasks
- [x] 1. Backend - Update data model types
- [x] 2. Backend - Data migration
- [ ] 3. Backend - CRUD commands for new fields
- [ ] 4. Backend - OpenCode server management
- [ ] 5. Backend - Execution orchestration command
- [ ] 6. Frontend - Update useTasksStorage hook with new types
- [ ] 7. Frontend - Update useTasksStorage hook with execution functions
- [ ] 8. Frontend - Task creation flow update
- [ ] 9. Frontend - Subtask expandable component
- [ ] 10. Frontend - Running state animation
- [ ] 11. Frontend - Run/Stop button logic
- [ ] 12. Frontend - Loop (Run All) button
- [ ] 13. Frontend - Drag to reorder subtasks
- [ ] 14. Frontend - History section
- [ ] 15. Frontend - Execution log detail view in subtask
- [ ] 16. Frontend - OpenCode server lifecycle
- [ ] 17. Frontend - AI Generate subtasks feature
- [ ] 18. Backend - AI Generate subtasks command
- [ ] 19. Manual testing - Full flow verification

## Notes
- Tasks 8, 9, 10, 11, 14, 15, 17 should use the frontend-design skill
- No borders between sections, use headers as separators
- Neon border animation: white/gray gradient rotating around border
- Server starts lazily when entering Tasks plugin
- Each subtask execution creates a new opencode session
- AI edits JSON directly, path passed in prompt
- Learnings from all previous executions included in prompt

## Design Decisions Summary
- Task = PRD (name, description, workingDirectory, subtasks)
- Subtask = PRD item (steps, category, shouldCommit, notes, executionLogs)
- Expand subtask with animation to see all details
- Run/Stop per subtask, Run All for loop
- One execution at a time, others disabled
- History: inline in subtask + aggregated section at bottom
- OpenCode Server API on port 4096
- Migration: automatic, preserves old data

---

## 2026-01-21 15:17 - Task 1: Backend - Update data model types

### What was implemented
- Added `TaskStatus` enum (waiting, in_progress, completed) for subtask status
- Added `SubtaskCategory` enum (functional, test) for categorizing subtasks
- Added `ExecutionOutcome` enum (success, partial, failed, aborted) for execution results
- Created `Step` struct (id, text, completed) for subtask checklist items
- Created `Learnings` struct with patterns/gotchas/context vectors
- Created `ExecutionLog` struct with all fields (id, startedAt, completedAt, duration, outcome, summary, filesChanged, learnings, committed, commitHash, commitMessage, errorMessage)
- Updated `Subtask` struct with new fields: status, order, category, steps, shouldCommit, notes, executionLogs
- Added legacy fields (completed, position) as Option with skip_serializing for migration compatibility
- Updated `Task` struct with description and workingDirectory fields
- Updated `TaskWithTags` response struct to include new Task fields
- Fixed all usages in commands.rs: subtasks_create, subtasks_toggle, subtasks_reorder, tasks_update_status cascade
- Fixed SQLite migration in storage.rs to include new Task fields

### Files changed
- `src-tauri/src/plugins/tasks/types.rs`
- `src-tauri/src/plugins/tasks/commands.rs`
- `src-tauri/src/plugins/tasks/storage.rs`

### Learnings for future iterations
- **Patterns discovered:**
  - All types use `#[serde(rename_all = "camelCase")]` for JS interop
  - Use `#[serde(default)]` for new fields to maintain backward compatibility
  - Use `#[serde(skip_serializing)]` for deprecated fields that should be read but not written
  - Enums use `#[serde(rename_all = "snake_case")]` for serialization
- **Gotchas encountered:**
  - When changing a field type (e.g., bool → enum), need to update all usages in commands.rs
  - SQLite migration also constructs Task manually, needs updating when Task fields change
  - TaskWithTags is a separate response struct that duplicates Task fields - must update both
- **Useful context:**
  - Subtask creation is in `subtasks_create` command at line ~384
  - Subtask toggle (now status change) is in `subtasks_toggle` command at line ~423
  - Task cascade (mark all subtasks complete) is in `tasks_update_status` command at line ~210

## 2026-01-21 15:18 - Task 2: Backend - Data migration

### What was implemented
- Created `migrate_subtask_data` function in storage.rs
- Migration logic: detects old format via `completed: Option<bool>` field presence
- Converts `completed: true` → `status: TaskStatus::Completed`, else `TaskStatus::Waiting`
- Converts `position: Option<i32>` → `order: u32`, falling back to array index
- Integrated into `load_or_migrate` flow - migrates on load from all sources (JSON, old todo.json)
- Saves migrated data immediately after migration for persistence
- Migration is idempotent: legacy fields use `skip_serializing` so they don't appear in output

### Files changed
- `src-tauri/src/plugins/tasks/storage.rs`

### Learnings for future iterations
- **Patterns discovered:**
  - Using `Option::take()` is idiomatic for detecting and consuming legacy fields
  - Migration in `load_or_migrate` (not `load_from_json`) allows unified handling across all data sources
  - The `#[serde(default, skip_serializing)]` pattern makes migrations transparent: old data deserializes, new data doesn't include legacy fields
- **Gotchas encountered:**
  - Must save migrated data immediately, otherwise migration runs on every load (performance hit + log spam)
  - The `order` field defaults to 0, so we need to check `index > 0` to avoid false positives for first items
- **Useful context:**
  - Data paths: `~/.local/share/jubby/tasks/tasks.json` (current), `~/.local/share/jubby/todo/todo.json` (legacy)
  - `load_or_migrate` is the single entry point for all data loading in the tasks plugin

