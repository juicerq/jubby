## Architecture Decisions - Tags

### Type Structures

```typescript
// src/plugins/todo/types.ts

export interface Tag {
  id: string          // crypto.randomUUID()
  name: string        // Max length: 20 chars (reasonable for UI)
  color: string       // Hex color from predefined palette
}

export interface Todo {
  id: string
  text: string
  completed: boolean
  createdAt: number
  tagIds?: string[]   // Optional, max 3 elements. Optional for backward compat.
}

export interface TodoStorage {
  todos: Todo[]
  tags: Tag[]         // New field, defaults to [] for migration
}
```

### Navigation Strategy

Use a local `view` state in TodoPlugin to switch between views:

```typescript
type TodoView = 'list' | 'tags'
const [view, setView] = useState<TodoView>('list')
```

- No URL routing needed (plugin is self-contained in popover)
- Simple state toggle: 'list' (default) ↔ 'tags'
- Back button in tag view calls `setView('list')`
- Tag button in list view calls `setView('tags')`

### Component Hierarchy

```
TodoPlugin.tsx (main component)
├── TodoPluginInput         # Existing - will add tag selection UI
├── TodoPluginEmptyState    # Existing - unchanged
├── TodoPluginList          # Existing - unchanged
├── TodoPluginItem          # Existing - will add tag badges display
├── TodoPluginTagButton     # NEW - button to access tag management (uses lucide Tag icon)
├── TodoPluginTagBadge      # NEW - reusable tag badge (color + name)
├── TodoPluginTagSelector   # NEW - inline tag chips for selecting tags
└── TodoPluginTagManager    # NEW - full view for tag CRUD
    ├── TodoPluginTagManagerHeader  # Back button + title
    ├── TodoPluginTagManagerInput   # Create new tag (name + color picker)
    ├── TodoPluginTagManagerList    # List of existing tags
    └── TodoPluginTagManagerItem    # Single tag with edit/delete
```

All components stay in TodoPlugin.tsx as mini-components (following existing pattern).

### Data Flow

1. **State ownership:** TodoPlugin owns all state via `usePluginStorage<TodoStorage>`
2. **Tag CRUD operations:** Functions in TodoPlugin, passed to children as props
   - `handleCreateTag(name: string, color: string)`
   - `handleEditTag(id: string, updates: Partial<Tag>)`
   - `handleDeleteTag(id: string)` - also removes tagId from all todos
3. **Todo-Tag association:**
   - `handleToggleTagOnTodo(todoId: string, tagId: string)` - add/remove tag
   - Validation: max 3 tags per todo, enforced in handler
4. **Props flow down, callbacks bubble up** (standard React pattern)

### Migration Strategy

The `usePluginStorage` hook handles migration transparently:

```typescript
const defaultStorage: TodoStorage = {
  todos: [],
  tags: []  // NEW: empty array default
}

const { data, setData, isLoading } = usePluginStorage<TodoStorage>('todo', defaultStorage)
```

- Old data format: `{ todos: [...] }` (no `tags` field)
- On first load: hook merges with default, adding `tags: []`
- On first save: full structure is persisted
- Old todos without `tagIds` work fine (field is optional)

No explicit migration code needed - the default merge behavior handles it.

### Edge Cases

1. **Tag deleted with tasks associated:**
   - `handleDeleteTag` iterates all todos and filters out the deleted tagId
   - Atomic operation: tag removed AND todos updated in single `setData` call

2. **Limit of 3 tags per task:**
   - `handleToggleTagOnTodo` checks `todo.tagIds.length < 3` before adding
   - UI disables unselected tags when limit reached (visual feedback)
   - Error ignored silently (no toast/alert needed - UI prevents it)

3. **Duplicate tag names (case insensitive):**
   - Validation in `handleCreateTag` and `handleEditTag`
   - Check: `tags.some(t => t.name.toLowerCase() === newName.toLowerCase() && t.id !== editingId)`
   - Prevent save if duplicate detected
   - UI shows inline error message

4. **Empty tag name:**
   - Validation: `name.trim().length === 0` prevents creation
   - Submit button disabled while name empty

5. **Tag color default:**
   - First color in palette (#ef4444 red) is pre-selected
   - User can change before creating

6. **Orphaned tagIds (tag deleted but todo still references):**
   - Already handled by atomic delete (see #1)
   - Defensive: TagBadge component filters out non-existent tags when rendering

---

## Codebase Patterns
- Plugin structure: `index.tsx` (manifest only) + `PluginName.tsx` (component) + `types.ts`
- Mini-components named as `ParentComponent` + `Part` (e.g., `TodoPluginInput`, `TodoPluginList`)
- Use `usePluginStorage<T>('plugin-id', defaultValue)` for plugin persistence

---

## 2026-01-13 - US-001
- What was implemented: Restructured Todo plugin to follow standard plugin structure
- Files changed:
  - Created `src/plugins/todo/TodoPlugin.tsx` with TodoPlugin component and mini-components
  - Simplified `src/plugins/todo/index.tsx` to only export TodoManifest
  - `types.ts` kept unchanged as required
- **Learnings for future iterations:**
  - Renamed `TodoApp` to `TodoPlugin` and all mini-components from `TodoApp*` to `TodoPlugin*` to follow naming convention
  - Main component should be named after the plugin file (e.g., `TodoPlugin` in `TodoPlugin.tsx`)
  - Export statement at bottom of component file: `export { TodoPlugin }`
---

## 2026-01-13 - US-002
- What was implemented: Fixed import direction so core/ doesn't import from plugins/
- Files changed:
  - `src/core/components/PluginGrid.tsx`: Removed `import { plugins } from '@/plugins/registry'`, added `plugins: PluginManifest[]` prop
  - `src/App.tsx`: Added `import { plugins } from '@/plugins/registry'`, passed plugins prop to PluginGrid
- **Learnings for future iterations:**
  - Import direction rule: `shared/` ← `core/` ← `plugins/` (unidirectional)
  - App.tsx sits at the root level and can import from anywhere (it orchestrates core + plugins)
  - When core/ needs data from plugins/, pass it as a prop from the parent component
---

## 2026-01-13 - US-003
- What was implemented: Replaced inline SVGs with lucide-react icons
- Files changed:
  - `src/core/components/PluginHeader.tsx`: SVG back arrow → `<ChevronLeft />`
  - `src/core/components/PluginGrid.tsx`: SVG search icon → `<Search />`
  - `src/plugins/todo/TodoPlugin.tsx`: SVG check → `<Check />`, SVG X → `<X />`
- **Learnings for future iterations:**
  - lucide-react icons accept `size` prop for width/height or `className` for Tailwind sizing
  - Use `className` for positioning and color (e.g., `className="w-3.5 h-3.5 text-white/35"`)
  - Icons inherit `currentColor` by default, just like SVGs with `stroke="currentColor"`
---

## 2026-01-13 - US-004
- What was implemented: Migrated LauncherShell CSS from index.css to Tailwind classes
- Files changed:
  - `src/core/components/LauncherShell.tsx`: Replaced `.launcher-shell` CSS class with Tailwind classes and inline style for gradient
  - `src/index.css`: Removed `.launcher-shell` CSS block (lines 131-144)
- **Learnings for future iterations:**
  - Complex radial gradients cannot be expressed in Tailwind directly - use inline `style` prop
  - Tailwind arbitrary values for shadow: `shadow-[0_0_0_1px_rgba(0,0,0,0.8),...]`
  - Border opacity uses Tailwind syntax: `border-white/8` (8% opacity)
  - `rounded-xl` equals `border-radius: 12px` in Tailwind
---

## 2026-01-13 - US-005
- What was implemented: Migrated PluginHeader CSS from index.css to Tailwind classes
- Files changed:
  - `src/core/components/PluginHeader.tsx`: Replaced all `.plugin-header*` CSS classes with Tailwind inline classes
  - `src/index.css`: Removed `.plugin-header*` CSS block (~53 lines)
- **Learnings for future iterations:**
  - Tailwind `tracking-tight` is equivalent to `letter-spacing: -0.05em`, but `tracking-[-0.01em]` can be used for precise control (original CSS used `-0.01em`)
  - For button hover/active states, chain modifiers: `hover:bg-white/6 hover:text-white/90 active:scale-[0.92]`
  - `shrink-0` is Tailwind equivalent of `flex-shrink: 0`
  - Height 48px = `h-12` in Tailwind (12 * 4 = 48)
---

## 2026-01-13 - US-006
- What was implemented: Migrated ViewTransition CSS from index.css to Tailwind classes
- Files changed:
  - `src/core/components/ViewTransition.tsx`: Replaced `.view-transition` CSS class and `data-visible` attribute with inline Tailwind classes using conditional `isVisible` state
  - `src/index.css`: Removed `.view-transition*` CSS block (~17 lines)
- **Learnings for future iterations:**
  - Data attribute pattern (`data-visible="true"`) can be replaced with conditional className using state directly
  - `transition-[opacity,transform]` allows specifying multiple transition properties in Tailwind
  - `translate-y-1.5` = 6px (1.5 * 4 = 6), `scale-[0.98]` for arbitrary scale values
  - Duration can be arbitrary: `duration-[180ms]`
---

## 2026-01-13 - US-007
- What was implemented: Evaluated scrollbar CSS and documented as intentional exception
- Files changed:
  - `src/index.css`: Added comment documenting scrollbar CSS as exception
  - `CLAUDE.md`: Added `::-webkit-scrollbar` exception to Estilização rules
- **Learnings for future iterations:**
  - `::-webkit-scrollbar` pseudo-elements cannot be styled with Tailwind utilities
  - This is a standard pattern in Tailwind projects - browser scrollbar styling must remain in CSS
  - When something cannot be converted to Tailwind, document it clearly with a comment referencing the decision
  - Exceptions to "Tailwind for everything" rule: CSS variables for shadcn/ui, webkit scrollbar styling
---

## 2026-01-13 - US-008
- What was implemented: Migrated all Todo plugin CSS classes to Tailwind inline classes
- Files changed:
  - `src/plugins/todo/TodoPlugin.tsx`: Replaced all `.todo-*` CSS classes with Tailwind inline classes
  - `src/index.css`: Removed ~250 lines of Todo plugin CSS
- **Learnings for future iterations:**
  - Tailwind 4's built-in `animate-spin` utility works for loading spinners - no custom keyframes needed
  - Use named groups (`group/delete`) for nested hover state targeting (e.g., `group-hover/delete:text-red-500`)
  - Complex conditional classes with multiple states can use template literals with ternary expressions
  - Sibling selectors like `input:focus + span` can be replicated with `[input:focus+&]:opacity-100` arbitrary variant
  - For `line-through` with custom color, use `decoration-white/25` for text-decoration-color
---

## 2026-01-13 - US-009
- What was implemented: Final cleanup of index.css, removed unused CSS
- Files changed:
  - `src/index.css`: Removed unused `.transition-smooth` utility class (7 lines)
- **Learnings for future iterations:**
  - Use `grep` to verify if a CSS class is actually used before removing
  - Final CSS structure: Tailwind imports → @theme (shadcn) → :root/:dark CSS vars → @layer base → scrollbar exception
  - All project-specific styling now lives inline in components using Tailwind classes
---

## 2026-01-13 - US-000 (Tag System PRD)
- What was implemented: Documented architecture decisions for tag system feature
- Files changed:
  - `ralph/progress.txt`: Added "Architecture Decisions - Tags" section with complete design documentation
  - `ralph/prd.json`: Marked US-000 as passes: true
- **Learnings for future iterations:**
  - Architecture documentation BEFORE implementation helps clarify edge cases upfront
  - The `usePluginStorage` default merge behavior makes migrations trivial - just add new fields with defaults
  - Mini-component pattern works well for complex views - keep all related components in one file
  - View state for plugin-internal navigation uses simple `useState<'list' | 'tags'>('list')`
---

## 2026-01-13 - US-001 (Tag System)
- What was implemented: Data model for tags system
- Files changed:
  - `src/plugins/todo/types.ts`: Added Tag interface, updated Todo with optional tagIds, updated TodoStorage with tags array
  - `src/plugins/todo/TodoPlugin.tsx`: Updated defaultStorage to include tags: []
- **Learnings for future iterations:**
  - When adding new fields to storage interfaces, always update the defaultStorage constant in the component
  - Optional fields with `?` (like `tagIds?: string[]`) ensure backward compatibility with existing data
---

## 2026-01-13 - US-002 (Tag System)
- What was implemented: Tag button for accessing tag management view
- Files changed:
  - `src/plugins/todo/TodoPlugin.tsx`:
    - Added `TodoView` type (`'list' | 'tags'`) and `view` state
    - Renamed `TodoPluginInput` to `TodoPluginInputArea` with added `onTagsClick` prop
    - Added `TodoPluginTagButton` mini-component (uses lucide `Tag` icon)
    - Added `TodoPluginTagManager` placeholder with header and empty state
    - Added `TodoPluginTagManagerHeader` with back button
- **Learnings for future iterations:**
  - Button styling follows same pattern as input: `h-10 w-10 rounded-[10px] bg-white/4` with hover states
  - Use `group` class on button for icon color transitions on hover
  - Placeholder views should follow same empty state pattern as main list (icon + text)
---

## 2026-01-13 - US-003 (Tag System)
- What was implemented: Full tag management view with list and create functionality
- Files changed:
  - `src/plugins/todo/TodoPlugin.tsx`:
    - Added `TAG_COLORS` constant with predefined 8-color palette
    - Added `handleCreateTag` handler with validation (non-empty, unique name case-insensitive)
    - Replaced `TodoPluginTagManager` placeholder with full implementation
    - Added `TodoPluginTagManagerEmptyState` mini-component
    - Added `TodoPluginTagManagerList` mini-component for tag list
    - Added `TodoPluginTagManagerItem` mini-component with colored badge
    - Color selector with 8 color dots, ring highlight for selection
- **Learnings for future iterations:**
  - When using `useState` with `as const` array values, explicitly type the state as `string` to avoid narrow type inference
  - Badge background uses hex color with `20` opacity suffix (e.g., `${tag.color}20`) for subtle tint
  - Ring offset needs explicit background color: `ring-offset-[#0a0a0a]` to match app background
  - Validation returns boolean from handler so component can show appropriate error message
---

## 2026-01-13 - US-004 (Tag System)
- What was implemented: Verified that US-003 already implemented all US-004 requirements
- Files changed: None - functionality already complete from US-003
- **Learnings for future iterations:**
  - Review existing implementation before starting work - features may have been implemented ahead of schedule
  - US-003 (tag management view) inherently includes US-004 (create tag) functionality
  - When PRD stories have overlapping scope, earlier stories may satisfy later acceptance criteria
---

## 2026-01-13 - US-005 (Tag System)
- What was implemented: Inline editing for existing tags in tag management view
- Files changed:
  - `src/plugins/todo/TodoPlugin.tsx`:
    - Added `handleEditTag` handler with validation (unique name case-insensitive, non-empty)
    - Updated `TodoPluginTagManager` props to include `onEditTag`
    - Updated `TodoPluginTagManagerList` with `editingId` state to track which tag is being edited
    - Rewrote `TodoPluginTagManagerItem` to support inline edit mode with name input and color selector
    - Edit mode UI: input field + save (check) + cancel (X) buttons + 8-color palette
    - Non-editing state shows "Click to edit" hint on hover
- **Learnings for future iterations:**
  - Handler returning `boolean | string` pattern works well for validation - returns `true` on success or error message string on failure
  - `useEffect` to reset edit state when `isEditing` changes ensures clean state when switching between tags
  - Keyboard shortcuts (Enter to save, Escape to cancel) improve UX for inline edit forms
  - Tag item changed from `<div>` to `<button>` for better accessibility and click handling
---

## 2026-01-13 - US-006 (Tag System)
- What was implemented: Two-click delete functionality for tags in tag management view
- Files changed:
  - `src/plugins/todo/TodoPlugin.tsx`:
    - Added `handleDeleteTag` handler that removes tag from `tags` array AND removes tagId from all todos
    - Updated `TodoPluginTagManager` props and component to include `onDeleteTag`
    - Updated `TodoPluginTagManagerList` with `pendingDeleteId` state and auto-reset timeout (1500ms)
    - Updated `TodoPluginTagManagerItem` to include delete button with two-click confirmation
    - Delete button shows X icon by default, changes to Check icon in pending state
    - Refactored tag item from single button to div container with edit button + delete button
- **Learnings for future iterations:**
  - Same two-click pattern from todo deletion: `pendingDeleteId` state + `useEffect` with 1500ms timeout
  - When splitting a clickable element into multiple buttons, wrap in a container div with hover styles, not on individual buttons
  - Delete handler must be atomic: update both `tags` and `todos` in single `setData` call to prevent orphaned references
  - `e.stopPropagation()` on delete button click prevents triggering parent's edit action
---
