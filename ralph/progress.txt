# Todo Folders System - Progress Log

## Feature Overview
Implement a folder system for the Todo plugin. The main screen shows a list of folders with previews of the last 2 todos. Clicking a folder navigates to the existing todo/tags view, now scoped to that folder.

## Design Decisions
- Navigation: Back button in header (uses existing plugin header customization)
- Tags: Isolated per folder (not global)
- Folder creation: "+" button reveals inline input
- Folder display: Vertical list with preview of 2 most recent todos
- Folder management: Rename, delete, reorder (drag & drop)
- Deletion: Confirmation modal with 5-second countdown on delete button

---

## 2026-01-16 - Task 1: Backend - Create folders table and migrate existing data
- What was implemented:
  - Created `folders` table with columns: id, name, position, created_at
  - Added `folder_id` column to `todos` table with foreign key (ON DELETE CASCADE)
  - Added `folder_id` column to `tags` table with foreign key (ON DELETE CASCADE)
  - Changed tags uniqueness constraint from global to per-folder (UNIQUE(name, folder_id))
  - Created `migrate_to_folders_schema()` function that:
    - Creates a "Default" folder
    - Migrates existing todos and tags to the default folder
    - Uses table recreation pattern (SQLite doesn't support ADD COLUMN with FK easily)
  - Updated `migrate_legacy_json()` to include folder_id when importing from JSON
- Files changed:
  - `src-tauri/src/storage/migrations.rs`
- **Learnings for future iterations:**
  - SQLite doesn't support ALTER TABLE ADD COLUMN with foreign key constraints well - use table recreation pattern
  - Check column existence with `conn.prepare("SELECT col FROM table LIMIT 1").is_ok()`
  - Cargo workspace is in `src-tauri/`, not project root
  - Migration runs on every startup - use `CREATE TABLE IF NOT EXISTS` for idempotency
  - The `execute_batch` function doesn't support parameterized queries - use format! for dynamic values

---

## 2026-01-16 - Task 2: Backend - Implement folder CRUD commands
- What was implemented:
  - Created `folder.rs` module with 5 Tauri commands:
    - `folder_get_all`: Returns all folders with `todoCount` and `recentTodos` (last 2 todos preview)
    - `folder_create`: Creates new folder with auto-incremented position, validates non-empty name
    - `folder_rename`: Renames folder by ID, validates non-empty name
    - `folder_delete`: Deletes folder (CASCADE handles todos/tags cleanup)
    - `folder_reorder`: Accepts ordered list of folder IDs and updates positions
  - Response types use `#[serde(rename_all = "camelCase")]` for frontend compatibility
  - Registered module in `storage/mod.rs`
  - Registered all 5 commands in `lib.rs` invoke_handler
- Files changed:
  - `src-tauri/src/storage/folder.rs` (new file)
  - `src-tauri/src/storage/mod.rs`
  - `src-tauri/src/lib.rs`
- **Learnings for future iterations:**
  - Follow same patterns as `todo.rs`: State<Database>, map_err for errors, filter_map for queries
  - Position field uses `COALESCE(MAX(position), -1) + 1` for next position calculation
  - For N+1 queries (getting count/recent for each folder), consider JOIN optimization if performance becomes an issue
  - Folder deletion relies on CASCADE - no need to manually delete todos/tags

---

## 2026-01-16 - Task 3: Backend - Update existing todo/tag commands to use folder_id
- What was implemented:
  - Replaced `todo_get_all` with `todo_get_by_folder(folder_id)`:
    - Now filters todos and tags by the specified folder_id
    - Queries use `WHERE folder_id = ?1` for both todos and tags
  - Updated `todo_create` to receive `folder_id` parameter:
    - Added `folder_id` as the first parameter (before text and tag_ids)
    - INSERT now includes folder_id column
  - Updated `tag_create` to receive `folder_id` parameter:
    - Added `folder_id` as the first parameter (before name and color)
    - INSERT now includes folder_id column
  - Updated error messages to clarify per-folder scope:
    - Both `tag_create` and `tag_update` now show "Tag name already exists in this folder"
  - Updated command registration in `lib.rs` to use `todo_get_by_folder` instead of `todo_get_all`
- Files changed:
  - `src-tauri/src/storage/todo.rs`
  - `src-tauri/src/lib.rs`
- **Learnings for future iterations:**
  - Tag uniqueness is enforced by DB constraint `UNIQUE(name, folder_id)` - no additional code needed
  - When renaming commands, update both the function and the invoke_handler registration
  - The `tag_update` function doesn't need folder_id since it updates by tag ID (folder_id is immutable after creation)

---

## 2026-01-16 - Task 4: Frontend - Add Folder type and update useTodoStorage hook
- What was implemented:
  - Added `Folder` and `RecentTodo` interfaces to `types.ts`:
    - `RecentTodo`: id, text, status (matches backend `RecentTodo` struct)
    - `Folder`: id, name, position, createdAt, todoCount, recentTodos
  - Updated `useTodoStorage` hook to require `folderId` parameter:
    - Changed `todo_get_all` call to `todo_get_by_folder(folderId)`
    - Updated `createTodo` to pass `folderId` to backend
    - Updated `createTag` to pass `folderId` to backend
    - Added `folderId` to the dependencies array for relevant callbacks
  - Created new `useFolderStorage` hook with folder operations:
    - `loadFolders`: Fetches all folders from backend
    - `createFolder`: Creates folder with optimistic update (temp ID pattern)
    - `renameFolder`: Renames folder with rollback on error
    - `deleteFolder`: Deletes folder with rollback on error
    - `reorderFolders`: Reorders folders based on ID array with rollback
  - Updated `TodoPlugin` to use the folder system:
    - Uses `useFolderStorage` to get folders
    - Uses first folder's ID as `currentFolderId` for `useTodoStorage`
    - Combines loading states from both hooks
- Files changed:
  - `src/plugins/todo/types.ts`
  - `src/plugins/todo/useTodoStorage.ts`
  - `src/plugins/todo/TodoPlugin.tsx`
- **Learnings for future iterations:**
  - Follow the existing optimistic update patterns: temp ID for creates, previous state capture for updates/deletes
  - When a hook requires a parameter, dependent components need to provide it - may require temporary scaffolding
  - The `folders[0]?.id ?? ''` pattern is a temporary solution until proper folder navigation is implemented in Task 5/6
  - Backend response types with `#[serde(rename_all = "camelCase")]` map directly to frontend interfaces

